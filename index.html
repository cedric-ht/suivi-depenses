<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compta Auto – Pour comptables</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { font-family: Arial; text-align: center; background: #f4f4f4; margin: 0; padding: 20px; }
    .container { max-width: 600px; margin: 40px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    input, button { padding: 12px; margin: 10px; font-size: 16px; width: 80%; }
    button { background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { background: #95a5a6; cursor: not-allowed; }
    .price { font-size: 28px; color: #27ae60; font-weight: bold; margin: 20px 0; }
    #result { margin-top:20px; white-space: pre-wrap; }
    .locked { opacity: 0.5; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Compta Auto – Pour comptables</h1>
    <p>Vos TPE envoient photo → PDF auto → import direct dans Pennylane</p>
    <p style="font-weight:bold; color:#e74c3c;">7 jours GRATUIT – Annulation quand tu veux</p>

    <div id="paywall">
      <p class="price">49 € / mois</p>
      <button id="checkout-button">S'abonner (7 jours gratuit)</button>
      <p><small>Carte requise – Annulation 1 clic</small></p>
    </div>

    <div id="scanner" class="locked">
      <input type="file" id="facture" accept="image/*">
      <input type="email" id="tpeEmail" placeholder="Email du TPE">
      <button onclick="scan()" disabled id="scan-btn">Scanner & Générer PDF</button>
    </div>

    <div id="result"></div>
  </div>

  <script>
    const stripe = Stripe('pk_test_51SSfm6J5kUYnkFiUAI90qtKYCeTK2EInJzdZgnVAVUp3VwyBLEExoYR9dwRgv3WCckg3MIbhE15TfzNJqOsaEN9100Lg7Oawdg'); // ← TA CLÉ PUBLIABLE STRIPE
    const PRICE_ID = 'price_1STFfGJ5kUYnkFiUSp4NGfro'; // ← TON ID DE PRIX STRIPE

    document.getElementById('checkout-button').addEventListener('click', () => {
      fetch('https://ton-serveur.com/create-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ priceId: PRICE_ID })
      })
      .then(res => res.json())
      .then(session => stripe.redirectToCheckout({ sessionId: session.id }));
    });

    // VÉRIFIE SI L'UTILISATEUR EST PAYANT (via cookie ou URL)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('paid') === 'true') {
      document.getElementById('paywall').style.display = 'none';
      document.getElementById('scanner').classList.remove('locked');
      document.getElementById('scan-btn').disabled = false;
    }

    async function scan() {
      if (document.getElementById('scanner').classList.contains('locked')) {
        return alert("Abonnement requis");
      }

      const file = document.getElementById('facture').files[0];
      const tpeEmail = document.getElementById('tpeEmail').value;
      if (!file || !tpeEmail) return alert("Photo + email requis");

      document.getElementById("result").innerHTML = "OCR Pro en cours...";

      const formData = new FormData();
      formData.append('file', file);
      formData.append('apikey', 'K87856793288957');
      formData.append('language', 'fre');
      formData.append('isOverlayRequired', 'false');
      formData.append('isCreateSearchablePdf', 'false');
      formData.append('OCREngine', '2');

      const response = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
      const data = await response.json();

      if (data.IsErroredOnProcessing) {
        document.getElementById("result").innerHTML = "Erreur API : " + data.ErrorMessage;
        return;
      }
      if (data.ParsedResults && data.ParsedResults[0]) {
        const text = data.ParsedResults[0].ParsedText;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(12);
        doc.text(`Facture reçue de ${tpeEmail}`, 10, 10);
        const lines = doc.splitTextToSize(text, 180);
        doc.text(lines, 10, 20);
        doc.text(`Prêt à importer dans Pennylane.`, 10, 280);
        const pdfBlob = doc.output('blob');
        const url = URL.createObjectURL(pdfBlob);
        document.getElementById("result").innerHTML = `
          <pre style="text-align:left; font-size:12px;">${text}</pre><br>
          <a href="${url}" download="facture_pennylane.pdf">Télécharger PDF</a><br>
          <p style="color:green; font-weight:bold;">PDF prêt – Accès illimité</p>
        `;
      }
    }
  </script>
</body>
</html>
